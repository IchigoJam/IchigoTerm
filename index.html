<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<title>IchigoTerm</title>
</head><body>
<h1>IchigoTerm</h1>

<main id=main>
  <textarea id=talog></textarea>
  <form id=form><input id=inp><button id=btnsend>SEND</button></form>

  <div class=buttons>
    <button id=btnreq>connect</button> â†’ 
    <button id=btnled1>LED1</button>
    <button id=btnled0>LED0</button>
    <button id=btnesc>ESC</button>
    <label><input type=checkbox id=mixjuice>MixJuice</label>
  </div>
</main>

<hr>
<a href=https://github.com/ichigojam/IchigoTerm/>src on GitHub</a>

<script type="module">
import { BufferedReader } from "https://js.sabae.cc/BufferedReader.js";
import { TextWriter } from "https://js.sabae.cc/TextWriter.js";
import { sleep } from "https://js.sabae.cc/sleep.js";

const fetchAndPut = async (url, post) => {
  try {
    const opt = !post ? undefined : {
      method: "POST",
      body: encodeBin(post),
      headers: {
        //"Content-type": "application/octet-stream",
        "Content-type": "text/plain",
      },
    };
    const bin = await (await fetch(url, opt)).arrayBuffer();
    const s = new Uint8Array(bin);
    for (let i = 0; i < s.length; i++) {
      const c = s[i];
      putc(c);
      await sleep(30);
      if (!iopanel.chkmixjuice.checked) {
        break;
      }
    }
  } catch (e) {
    console.log(e);
  }
};

export class MixJuice {
  constructor() {
    this.buf = "";
    this.posts = null;
    this.postsurl = null;
  }
  write(c) {
    for (;;) {
      this.buf += c;
      const n = this.buf.indexOf("\n");
      if (n < 0) {
        return;
      }
      const s = this.buf.substring(n);
      this.buf = this.buf.substring(n + 1);

      if (s.startsWith("MJ ")) {
        if (s.startsWith("MJ GET ")) {
          const url = "http://" + s.substring(7);
          fetchAndPut(url);
        } else if (s.startsWith("MJ GETS ")) {
          const url = "https://" + s.substring(8);
          fetchAndPut(url);
        } else if (s.startsWith("MJ POSTS START ")) {
          this.postsurl = "https://" + s.substring(15);
          console.log(postsurl)
          this.posts = [];
          return;
        } else if (s == "MJ POSTS END") {
          fetchAndPut(this.postsurl, this.posts.join("\n"));
        }
        /*
        MJ PCT contenttype
        */
      }
      if (this.posts != null) {
        this.posts.push(s);
      }
		}
  }
  async read() {

  }
}

export const scrollBottom = (comp) => {
  comp.scroll(0, comp.scrollHeight - comp.clientHeight);
};

const log = (s) => {
  talog.value += s;
  scrollBottom(talog);
};

const main = async (port) => {
  const baudRate = 115200;
  await port.open({ baudRate });
  const writer = new TextWriter(port.writable.getWriter());
  const reader = new BufferedReader(port.readable.getReader({ mode: "byob" }));

  const send = (s) => {
    writer.writeString(s);
    log(s);
  };
  btnsend.onclick = form.onsubmit = (e) => {
    const s = inp.value + "\n";
    send(s);
    inp.value = "";
    e.preventDefault();
  };
  btnled1.onclick = () => {
    send("LED1\n");
  };
  btnled0.onclick = () => {
    send("LED0\n");
  };
  btnesc.onclick = () => {
    send("\x1b");
  };
  const loop = async () => {
    for (;;) {
      const b = await reader.readByte();
      const c = String.fromCharCode(b);
      log(c);
    }
  };
  loop();
}
btnreq.onclick = async () => {
  const port = await navigator.serial.requestPort();
  main(port);
};

const ports = await navigator.serial.getPorts();
if (ports.length > 0) {
  main(ports[0]);
}

</script>

<style>
* {
  box-sizing: border-box;
}
body {
  text-align: center;
}
main {
  padding: 2em;
}
#talog {
  height: 400px;
  display: block;
  width: 100%;
  border: 1px solid gray;
}
#inp {
  width: 90%;
}
#btnsend {
  width: 10%;
}
.buttons {
  margin: 1em;
}
</style>
</body><html>
